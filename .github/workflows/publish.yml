name: Publish to crates.io

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (validate only, do not publish)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish crate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.cargo/registry/src/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Read version from Cargo.toml
        id: version
        shell: bash
        run: |
          VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed 's/.*version\s*=\s*"\(.*\)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not determine version from Cargo.toml"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version from Cargo.toml: $VERSION"

      - name: Validate version format
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "Error: Invalid version format: $VERSION"
            echo "Version must match semver format (e.g., 0.0.1 or 0.0.1-alpha.1)"
            exit 1
          fi
          echo "Version format is valid: $VERSION"

      - name: Validate CARGO_REGISTRY_TOKEN
        shell: bash
        env:
          TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "$TOKEN" ]; then
            echo "Error: CARGO_REGISTRY_TOKEN secret is not set or is empty"
            echo "Please configure CARGO_REGISTRY_TOKEN in GitHub repository secrets:"
            echo "Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          TOKEN_LENGTH=${#TOKEN}
          echo "CARGO_REGISTRY_TOKEN is configured (length: $TOKEN_LENGTH chars)"

      - name: Configure Cargo registry
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << EOF
          [registry]
          token = "${{ secrets.CARGO_REGISTRY_TOKEN }}"
          EOF
          echo "Cargo registry token configured"

      - name: Publish foxchain-id
        if: github.event.inputs.dry_run != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish --token "$CARGO_REGISTRY_TOKEN" || {
            echo "Error: Failed to publish foxchain-id"
            exit 1
          }
          echo "Successfully published foxchain-id"

      - name: Dry run validation
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "Dry run mode: Validating publish readiness..."
          cargo publish --dry-run --allow-dirty || {
            echo "Error: foxchain-id dry run failed"
            exit 1
          }
          echo "Crate passed dry run validation"

      - name: Publish summary
        if: always()
        shell: bash
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "## Dry Run Results ✅" >> $GITHUB_STEP_SUMMARY
            echo "Crate validated successfully. Ready for publishing." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" == "success" ]; then
            echo "## Publishing Complete ✅" >> $GITHUB_STEP_SUMMARY
            echo "foxchain-id published successfully to crates.io" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Publishing Failed ❌" >> $GITHUB_STEP_SUMMARY
            echo "Failed to publish foxchain-id. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
